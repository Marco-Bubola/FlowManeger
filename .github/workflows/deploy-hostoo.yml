name: deploy-hostoo

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-hostoo-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Add Flux Credentials Loaded From ENV
        run: composer config http-basic.composer.fluxui.dev "${{ secrets.FLUX_USERNAME }}" "${{ secrets.FLUX_LICENSE_KEY }}"

      - name: Install PHP Dependencies (Production)
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

      - name: Install Node Dependencies
        run: npm ci

      - name: Build Assets
        run: npm run build

      - name: Validate required deploy secrets
        env:
          HOSTOO_HOST: ${{ secrets.HOSTOO_HOST }}
          HOSTOO_USER: ${{ secrets.HOSTOO_USER }}
          HOSTOO_PASSWORD: ${{ secrets.HOSTOO_PASSWORD }}
          HOSTOO_PORT: ${{ secrets.HOSTOO_PORT }}
          HOSTOO_APP_PATH: ${{ secrets.HOSTOO_APP_PATH }}
          HOSTOO_PUBLIC_PATH: ${{ secrets.HOSTOO_PUBLIC_PATH }}
        run: |
          [ -n "$HOSTOO_HOST" ] || (echo "Secret HOSTOO_HOST não definido" && exit 1)
          [ -n "$HOSTOO_USER" ] || (echo "Secret HOSTOO_USER não definido" && exit 1)
          [ -n "$HOSTOO_PASSWORD" ] || (echo "Secret HOSTOO_PASSWORD não definido" && exit 1)
          [ -n "$HOSTOO_PORT" ] || (echo "Secret HOSTOO_PORT não definido" && exit 1)
          [ -n "$HOSTOO_APP_PATH" ] || (echo "Secret HOSTOO_APP_PATH não definido" && exit 1)
          [ -n "$HOSTOO_PUBLIC_PATH" ] || (echo "Secret HOSTOO_PUBLIC_PATH não definido" && exit 1)

      - name: Upload app to HOSTOO_APP_PATH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOSTOO_HOST }}
          username: ${{ secrets.HOSTOO_USER }}
          password: ${{ secrets.HOSTOO_PASSWORD }}
          port: ${{ secrets.HOSTOO_PORT }}
          source: "app,artisan,bootstrap,config,database,resources,routes,scripts,storage,vendor,composer.json,composer.lock,package.json,package-lock.json,vite.config.js,tailwind.config.js,.env.example"
          target: ${{ secrets.HOSTOO_APP_PATH }}
          rm: false
          overwrite: true
          strip_components: 0

      - name: Upload public files to HOSTOO_PUBLIC_PATH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOSTOO_HOST }}
          username: ${{ secrets.HOSTOO_USER }}
          password: ${{ secrets.HOSTOO_PASSWORD }}
          port: ${{ secrets.HOSTOO_PORT }}
          source: "public/.htaccess,public/*"
          target: ${{ secrets.HOSTOO_PUBLIC_PATH }}
          rm: false
          overwrite: true
          strip_components: 1

      - name: Run remote post-deploy commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOSTOO_HOST }}
          username: ${{ secrets.HOSTOO_USER }}
          password: ${{ secrets.HOSTOO_PASSWORD }}
          port: ${{ secrets.HOSTOO_PORT }}
          script_stop: false
          script: |
            cd "${{ secrets.HOSTOO_APP_PATH }}"
            php artisan migrate --force || echo "Migrations already applied"
            php artisan storage:link || echo "Storage link already exists"
            php artisan config:cache
            php artisan route:cache
            php artisan event:cache
            php artisan view:cache
            php artisan optimize
